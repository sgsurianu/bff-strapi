---
import EditorLayout from "../../../layouts/EditorLayout.astro";

export const prerender = false;
---

<EditorLayout 
  title="Panel: Nueva Noticia" 
  description="Crear una nueva noticia"
>
  <section class="card">
    <h2 style="margin: 0 0 20px 0;">Crear Nueva Noticia</h2>

    <form
      id="createForm"
      method="post"
      onsubmit="return false;"
      style="display: grid; gap: 16px;"
    >
      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">Título *</div>
        <input
          type="text"
          name="title"
          required
          placeholder="Título de la noticia"
          style="width: 100%;"
        />
      </label>

      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">Extracto (resumen corto)</div>
        <textarea
          name="excerpt"
          rows="3"
          placeholder="Breve resumen de la noticia..."
          style="width: 100%;"
        ></textarea>
      </label>

      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">Contenido *</div>
        <textarea
          name="content"
          rows="10"
          required
          placeholder="Contenido completo de la noticia..."
          style="width: 100%; font-family: monospace;"
        ></textarea>
      </label>

      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">Autor</div>
        <input
          type="text"
          name="author"
          placeholder="Nombre del autor"
          style="width: 100%;"
        />
      </label>

      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">Fecha de publicación</div>
        <input
          type="date"
          name="publishedDate"
          style="width: 100%;"
        />
      </label>

      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">
          Etiquetas (separadas por comas)
        </div>
        <input
          type="text"
          name="tags"
          placeholder="tecnología, innovación, educación"
          style="width: 100%;"
        />
        <div style="font-size: 0.85rem; color: #666; margin-top: 4px;">
          Ejemplo: tecnología, salud, educación
        </div>
      </label>

      <label>
        <div style="font-weight: 600; margin-bottom: 6px;">Imagen (opcional)</div>
        <input id="fileInput" type="file" accept="image/*" />
      </label>

      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="submit">Crear noticia</button>
        <a
          href="/editor/noticias"
          style="
            display: inline-flex;
            align-items: center;
            padding: 10px 14px;
            border-radius: 10px;
            text-decoration: none;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #e0e0e0;
          "
        >
          Cancelar
        </a>
      </div>

      <div id="statusMessage" style="margin-top: 6px; font-weight: 500;"></div>
    </form>
  </section>

  <script is:inline>
    window.addEventListener("DOMContentLoaded", () => {
      const form = document.querySelector("#createForm");
      const fileInput = document.querySelector("#fileInput");
      const statusMessage = document.querySelector("#statusMessage");

      if (!form || !statusMessage) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusMessage.textContent = "Creando noticia...";
        statusMessage.style.color = "#0070f3";

        const fd = new FormData(form);
        const file = fileInput?.files && fileInput.files[0];

        let imageId = null;

        // Si hay imagen, subirla primero
        if (file) {
          statusMessage.textContent = "Subiendo imagen...";
          
          const uploadFd = new FormData();
          uploadFd.append("files", file, file.name);

          try {
            const upRes = await fetch("/api/panel/upload", {
              method: "POST",
              body: uploadFd,
            });

            if (!upRes.ok) {
              const upText = await upRes.text();
              statusMessage.textContent = "Error al subir imagen: " + upText;
              statusMessage.style.color = "#ff4444";
              return;
            }

            const uploaded = await upRes.json();
            const fileObj = Array.isArray(uploaded) ? uploaded[0] : uploaded;
            imageId = fileObj?.id ?? null;

            if (typeof imageId !== "number") {
              statusMessage.textContent = "Error: no se obtuvo el ID de la imagen";
              statusMessage.style.color = "#ff4444";
              return;
            }
          } catch (err) {
            console.error("Error subiendo imagen:", err);
            statusMessage.textContent = "Error de red al subir imagen";
            statusMessage.style.color = "#ff4444";
            return;
          }
        }

        // Procesar etiquetas
        const tagsInput = String(fd.get("tags") ?? "");
        const tagsArray = tagsInput
          .split(",")
          .map((t) => t.trim())
          .filter((t) => t.length > 0);

        // Construir payload
        const payload = {
          title: String(fd.get("title") ?? ""),
          content: String(fd.get("content") ?? ""),
          excerpt: String(fd.get("excerpt") ?? ""),
          author: String(fd.get("author") ?? ""),
          publishedDate: String(fd.get("publishedDate") ?? "") || null,
          tags: tagsArray,
        };

        if (typeof imageId === "number") {
          payload.image = imageId;
        }

        statusMessage.textContent = "Guardando noticia...";

        try {
          const res = await fetch("/api/panel/noticias", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            const text = await res.text();
            statusMessage.textContent = "Error al crear: " + text;
            statusMessage.style.color = "#ff4444";
            return;
          }

          statusMessage.textContent = "✓ Noticia creada correctamente. Redirigiendo...";
          statusMessage.style.color = "#00aa00";

          setTimeout(() => {
            window.location.href = "/editor/noticias";
          }, 1500);
        } catch (err) {
          console.error("Error creando:", err);
          statusMessage.textContent = "Error de red al crear";
          statusMessage.style.color = "#ff4444";
        }
      });
    });
  </script>
</EditorLayout>
