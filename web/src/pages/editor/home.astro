---
import EditorLayout from "../../layouts/EditorLayout.astro";
import { resolveMediaUrl } from "../../utils/strapi";

const r = await fetch(new URL("/api/panel/home", Astro.url));
if (!r.ok) throw new Error(`No se pudo cargar Home: ${r.status}`);

const json = await r.json();
const home = json?.data ?? null;

// Compatible con variantes de estructura de Strapi
const heroTitle = home?.heroTitle ?? home?.attributes?.heroTitle ?? "";
const heroSubtitle = home?.heroSubtitle ?? home?.attributes?.heroSubtitle ?? "";

// Media actual (para mostrar preview)
const heroImage = home?.heroImage ?? home?.attributes?.heroImage ?? null;
const heroImageUrl = resolveMediaUrl(heroImage);
---

<EditorLayout title="Panel: Editar Home" description="Editar contenido de la página principal">

    <section class="card">
      <h2 style="margin: 0 0 10px 0;">Imagen actual (heroImage)</h2>
      {heroImageUrl ? (
        <img
          src={heroImageUrl}
          alt="Hero actual"
          style="max-width: 100%; border-radius: 12px;"
        />
      ) : (
        <div style="color: #666;">No hay imagen asignada todavía.</div>
      )}
    </section>

    <section class="card">
      <h2 style="margin: 0 0 10px 0;">Editar textos</h2>
      <form
        id="homeForm"
        style="display: grid; gap: 12px;"
      >
        <label>
          <div style="font-weight: 600;">Hero Title</div>
          <input name="heroTitle" value={heroTitle} />
        </label>

        <label>
          <div style="font-weight: 600;">Hero Subtitle</div>
          <textarea name="heroSubtitle" rows="4">{heroSubtitle}</textarea>
        </label>

        <button type="submit">Guardar textos</button>

        <div id="statusText" style="margin-top: 6px;"></div>
      </form>
    </section>

    <section class="card">
      <h2 style="margin: 0 0 10px 0;">Actualizar imagen (heroImage)</h2>

      <div style="display: grid; gap: 10px;">
        <input id="fileInput" type="file" accept="image/*" />

        <button id="btnUpload" type="button">
          Subir y asignar imagen
        </button>

        <div id="statusImage"></div>

        <div style="margin-top: 6px;">
          <a href="/" target="_blank">Ver resultado en la web →</a>
        </div>
      </div>
    </section>

    <!-- SCRIPT COMPLETO -->
    <script is:inline>
      window.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector("#homeForm");
        const statusText = document.querySelector("#statusText");

        const fileInput = document.querySelector("#fileInput");
        const btnUpload = document.querySelector("#btnUpload");
        const statusImage = document.querySelector("#statusImage");

        // 1) Guardar textos
        if (form && statusText) {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            statusText.textContent = "Guardando textos...";

            const fd = new FormData(form);
            const payload = {
              heroTitle: String(fd.get("heroTitle") ?? ""),
              heroSubtitle: String(fd.get("heroSubtitle") ?? ""),
            };

            try {
              const res = await fetch("/api/panel/home", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              });

              const text = await res.text();
              if (!res.ok) {
                statusText.textContent = "Error al guardar textos: " + text;
                return;
              }

              statusText.textContent = "Textos guardados correctamente.";
            } catch (err) {
              console.error(err);
              statusText.textContent = "Error de red al guardar textos. Revisa consola.";
            }
          });
        }

        // 2) Subir imagen y asignarla
        if (btnUpload && fileInput && statusImage) {
          btnUpload.addEventListener("click", async () => {
            statusImage.textContent = "";

            const file = fileInput.files && fileInput.files[0];
            if (!file) {
              statusImage.textContent = "Selecciona una imagen primero.";
              return;
            }

            btnUpload.disabled = true;
            statusImage.textContent = "Subiendo imagen a Strapi...";

            try {
              // 2.1 Subir archivo
              const uploadFd = new FormData();
              uploadFd.append("files", file, file.name);

              const upRes = await fetch("/api/panel/upload", {
                method: "POST",
                body: uploadFd,
              });

              const upText = await upRes.text();
              if (!upRes.ok) {
                statusImage.textContent = "Error al subir: " + upText;
                btnUpload.disabled = false;
                return;
              }

              let uploaded;
              try {
                uploaded = JSON.parse(upText);
              } catch {
                statusImage.textContent = "Respuesta no-JSON al subir: " + upText;
                btnUpload.disabled = false;
                return;
              }

              // Strapi normalmente devuelve un array de archivos
              const fileObj = Array.isArray(uploaded) ? uploaded[0] : uploaded;
              const fileId = fileObj?.id;

              if (typeof fileId !== "number") {
                statusImage.textContent = "No se encontró id del archivo en la respuesta: " + upText;
                btnUpload.disabled = false;
                return;
              }

              statusImage.textContent = "Imagen subida. Asignando a Home... (id=" + fileId + ")";

              // 2.2 Asignar heroImage por id
              const putRes = await fetch("/api/panel/home", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ heroImage: fileId }),
              });

              const putText = await putRes.text();
              if (!putRes.ok) {
                statusImage.textContent = "Error al asignar heroImage: " + putText;
                btnUpload.disabled = false;
                return;
              }

              statusImage.textContent = "Imagen asignada correctamente. Recargando para mostrar preview...";
              window.location.reload();
            } catch (err) {
              console.error(err);
              statusImage.textContent = "Error de red en upload/asignación. Revisa consola.";
            } finally {
              btnUpload.disabled = false;
            }
          });
        }
      });
    </script>
</EditorLayout>
