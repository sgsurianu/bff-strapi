---
import BaseLayout from "../layouts/BaseLayout.astro";
import PortalHeader from "../components/portal/PortalHeader.astro";
import Carousel from "../components/portal/Carousel.astro";
import { resolveMediaUrl, getServiceImageUrl } from "../utils/strapi";

/* ---------------------------
   1) SITE SETTINGS (Banner)
----------------------------*/
let siteSettings: any = null;
let bannerImage: any = null;

try {
  const resSettings = await fetch(new URL("/api/panel/site-settings", Astro.url));
  if (resSettings.ok) {
    const json = await resSettings.json();
    siteSettings = json?.data ?? null;
    bannerImage = siteSettings?.bannerImage ?? siteSettings?.attributes?.bannerImage ?? null;
  }
} catch (e) {
  console.error("Error cargando site-settings:", e);
}

/* ---------------------------
   2) HOME (Carrusel)
----------------------------*/
const resHome = await fetch(new URL("/api/panel/home", Astro.url));
if (!resHome.ok) throw new Error(`BFF error (home): ${resHome.status}`);

const jsonHome = await resHome.json();
const home = jsonHome?.data ?? null;

// Extraer imágenes del carrusel
const carouselImages = home?.carouselImages ?? home?.attributes?.carouselImages ?? null;
let carouselImagesArray: any[] = [];

if (carouselImages) {
  if (Array.isArray(carouselImages)) {
    carouselImagesArray = carouselImages;
  } else if (carouselImages?.data && Array.isArray(carouselImages.data)) {
    carouselImagesArray = carouselImages.data;
  }
}

/* ---------------------------
   3) INFO BLOCKS (Bloques informativos)
----------------------------*/
let infoBlocks: any[] = [];
try {
  const resBlocks = await fetch(new URL("/api/panel/info-blocks", Astro.url));
  if (resBlocks.ok) {
    const json = await resBlocks.json();
    const blocks = json?.data ?? [];
    infoBlocks = Array.isArray(blocks) ? blocks : [];
  }
} catch (e) {
  console.error("Error cargando info-blocks:", e);
}

// Limitar a 3 bloques
const displayBlocks = infoBlocks.slice(0, 3);
---

<BaseLayout title="Portal DAGRAN - Inicio" description="Portal DAGRAN">
  <PortalHeader bannerImage={bannerImage} />

  <main style="max-width: 1200px; margin: 0 auto; padding: 32px 20px;">
    <!-- CARRUSEL -->
    {carouselImagesArray.length > 0 && (
      <section style="margin-bottom: 48px;">
        <Carousel images={carouselImagesArray} />
      </section>
    )}

    <!-- BLOQUES DE INFORMACIÓN INSTITUCIONAL -->
    {displayBlocks.length > 0 && (
      <section>
        <h2 style="margin: 0 0 24px 0; text-align: center; font-size: 2rem; color: #1a1a1a;">
          Información Institucional
        </h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
          {displayBlocks.map((block) => {
            const title = block?.title ?? block?.attributes?.title ?? "";
            const description = block?.description ?? block?.attributes?.description ?? "";
            const icon = block?.icon ?? block?.attributes?.icon ?? "";
            const link = block?.link ?? block?.attributes?.link ?? "";
            const image = block?.image ?? block?.attributes?.image ?? null;
            const imageUrl = getServiceImageUrl(image);

            const BlockContent = (
              <div style="
                border: 1px solid #e6e6e6;
                border-radius: 12px;
                overflow: hidden;
                background: #fff;
                transition: box-shadow 0.2s ease;
                height: 100%;
                display: flex;
                flex-direction: column;
              "
              onmouseover="this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.1)'"
              onmouseout="this.style.boxShadow='none'"
              >
                {imageUrl && (
                  <div style="width: 100%; height: 200px; overflow: hidden;">
                    <img
                      src={imageUrl}
                      alt={title}
                      style="width: 100%; height: 100%; object-fit: cover;"
                    />
                  </div>
                )}
                <div style="padding: 20px; flex: 1; display: flex; flex-direction: column;">
                  {icon && (
                    <div style="font-size: 2.5rem; margin-bottom: 12px;">{icon}</div>
                  )}
                  <h3 style="margin: 0 0 12px 0; font-size: 1.5rem; color: #1a1a1a;">
                    {title}
                  </h3>
                  {description && (
                    <p style="margin: 0; color: #666; line-height: 1.6; flex: 1;">
                      {description}
                    </p>
                  )}
                  {link && (
                    <a
                      href={link}
                      style="
                        display: inline-block;
                        margin-top: 16px;
                        color: #0070f3;
                        text-decoration: none;
                        font-weight: 500;
                      "
                    >
                      Ver más →
                    </a>
                  )}
                </div>
              </div>
            );

            return link ? (
              <a href={link} style="text-decoration: none; color: inherit;">
                {BlockContent}
              </a>
            ) : (
              BlockContent
            );
          })}
        </div>
      </section>
    )}

    {displayBlocks.length === 0 && (
      <section style="text-align: center; padding: 48px 20px; color: #666;">
        <p>No hay bloques de información institucional configurados.</p>
      </section>
    )}
  </main>
</BaseLayout>
