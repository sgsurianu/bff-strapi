---
import BaseLayout from "../layouts/BaseLayout.astro";
import PortalHeader from "../components/portal/PortalHeader.astro";
import { getServiceImageUrl } from "../utils/strapi";

export const prerender = false;

// Obtener par√°metros de b√∫squeda
const page = parseInt(Astro.url.searchParams.get("page") || "1");
const search = Astro.url.searchParams.get("search") || "";
const tag = Astro.url.searchParams.get("tag") || "";

const params = new URLSearchParams({
  page: String(page),
  pageSize: "12",
});

if (search) params.append("search", search);
if (tag) params.append("tag", tag);

let noticias: any[] = [];
let pagination: any = null;
let allTags = new Set<string>();
let error: string | null = null;

try {
  const r = await fetch(
    new URL(`/api/panel/noticias?${params.toString()}`, Astro.url)
  );

  if (r.ok) {
    const json = await r.json();
    noticias = json?.data ?? [];
    pagination = json?.meta?.pagination ?? null;

    // Extraer todas las etiquetas √∫nicas
    noticias.forEach((n: any) => {
      const tags = n?.tags ?? n?.attributes?.tags ?? [];
      if (Array.isArray(tags)) {
        tags.forEach((t: string) => allTags.add(t));
      }
    });
  } else {
    error = `Error ${r.status} al cargar noticias`;
  }
} catch (e) {
  error = e instanceof Error ? e.message : "Error desconocido";
}
---

<BaseLayout title="Noticias - Portal DAGRAN">
  <PortalHeader />

  <main style="max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <header style="text-align: center; margin-bottom: 40px;">
      <h1 style="font-size: 2.5rem; margin: 0 0 12px 0; color: #1a1a1a;">
        Noticias
      </h1>
      <p style="color: #666; font-size: 1.1rem;">
        Mantente informado con las √∫ltimas novedades del Portal DAGRAN
      </p>
    </header>

    <!-- Filtros de b√∫squeda -->
    <section style="background: #f9f9f9; padding: 24px; border-radius: 12px; margin-bottom: 40px;">
      <form method="GET" style="display: grid; gap: 16px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <label>
            <div style="font-weight: 600; margin-bottom: 8px;">Buscar noticias</div>
            <input 
              type="text" 
              name="search" 
              value={search}
              placeholder="Buscar por palabra clave..."
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                font-size: 1rem;
              "
            />
          </label>

          <label>
            <div style="font-weight: 600; margin-bottom: 8px;">Filtrar por etiqueta</div>
            <select 
              name="tag"
              style="
                width: 100%;
                padding: 12px;
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                font-size: 1rem;
              "
            >
              <option value="">Todas las etiquetas</option>
              {Array.from(allTags).sort().map((t) => (
                <option value={t} selected={tag === t}>{t}</option>
              ))}
            </select>
          </label>
        </div>

        <div style="display: flex; gap: 12px;">
          <button 
            type="submit"
            style="
              padding: 12px 24px;
              background: #0070f3;
              color: #fff;
              border: 0;
              border-radius: 8px;
              font-weight: 600;
              cursor: pointer;
              font-size: 1rem;
            "
          >
            üîç Buscar
          </button>
          <a
            href="/noticias"
            style="
              display: inline-flex;
              align-items: center;
              padding: 12px 24px;
              background: #fff;
              color: #333;
              border: 1px solid #e0e0e0;
              border-radius: 8px;
              text-decoration: none;
              font-weight: 600;
            "
          >
            Limpiar filtros
          </a>
        </div>
      </form>
    </section>

    {error ? (
      <div style="text-align: center; padding: 40px; color: #ff4444;">
        Error al cargar noticias: {error}
      </div>
    ) : noticias.length === 0 ? (
      <div style="text-align: center; padding: 60px; background: #f9f9f9; border-radius: 12px;">
        <div style="font-size: 3rem; margin-bottom: 16px;">üì∞</div>
        <h2 style="margin: 0 0 8px 0; color: #666;">No se encontraron noticias</h2>
        <p style="color: #999;">
          {search || tag ? "Intenta con otros criterios de b√∫squeda" : "Vuelve pronto para ver las √∫ltimas novedades"}
        </p>
      </div>
    ) : (
      <>
        <!-- Informaci√≥n de resultados -->
        {pagination && (
          <div style="color: #666; margin-bottom: 24px; text-align: center;">
            Mostrando {noticias.length} de {pagination.total} noticia{pagination.total !== 1 ? 's' : ''}
            {search && ` | B√∫squeda: "${search}"`}
            {tag && ` | Etiqueta: "${tag}"`}
          </div>
        )}

        <!-- Grid de noticias -->
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; margin-bottom: 40px;">
          {noticias.map((n: any) => {
            const title = n?.title ?? n?.attributes?.title ?? "Sin t√≠tulo";
            const excerpt = n?.excerpt ?? n?.attributes?.excerpt ?? "";
            const content = n?.content ?? n?.attributes?.content ?? "";
            const author = n?.author ?? n?.attributes?.author ?? "";
            const documentId = n?.documentId ?? String(n?.id);
            const tags = n?.tags ?? n?.attributes?.tags ?? [];
            const publishedDate = n?.publishedDate ?? n?.attributes?.publishedDate ?? 
                                 n?.createdAt ?? n?.attributes?.createdAt ?? "";
            const image = n?.image ?? n?.attributes?.image ?? null;
            const imageUrl = getServiceImageUrl(image);

            // Crear extracto si no existe
            const displayExcerpt = excerpt || (content.length > 150 ? content.substring(0, 150) + "..." : content);

            return (
              <article
                style="
                  background: #fff;
                  border: 1px solid #e0e0e0;
                  border-radius: 12px;
                  overflow: hidden;
                  transition: all 0.2s ease;
                  display: flex;
                  flex-direction: column;
                "
              >
                {imageUrl && (
                  <div style="width: 100%; height: 200px; overflow: hidden;">
                    <img
                      src={imageUrl}
                      alt={title}
                      style="width: 100%; height: 100%; object-fit: cover;"
                    />
                  </div>
                )}
                
                <div style="padding: 20px; flex: 1; display: flex; flex-direction: column;">
                  <h2 style="margin: 0 0 12px 0; font-size: 1.25rem; color: #1a1a1a;">
                    {title}
                  </h2>

                  {publishedDate && (
                    <div style="color: #999; font-size: 0.85rem; margin-bottom: 12px;">
                      üìÖ {new Date(publishedDate).toLocaleDateString('es-ES', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                      })}
                      {author && ` ‚Ä¢ Por ${author}`}
                    </div>
                  )}

                  <p style="margin: 0 0 16px 0; color: #666; line-height: 1.6; flex: 1;">
                    {displayExcerpt}
                  </p>

                  {Array.isArray(tags) && tags.length > 0 && (
                    <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: auto;">
                      {tags.slice(0, 3).map((t: string) => (
                        <a
                          href={`/noticias?tag=${encodeURIComponent(t)}`}
                          style="
                            padding: 4px 10px;
                            background: #e8f4ff;
                            color: #0070f3;
                            font-size: 0.8rem;
                            border-radius: 4px;
                            text-decoration: none;
                            font-weight: 500;
                          "
                        >
                          #{t}
                        </a>
                      ))}
                    </div>
                  )}
                </div>
              </article>
            );
          })}
        </div>

        <!-- Paginaci√≥n -->
        {pagination && pagination.pageCount > 1 && (
          <nav style="display: flex; gap: 12px; justify-content: center; align-items: center;">
            {pagination.page > 1 && (
              <a
                href={`/noticias?page=${pagination.page - 1}${search ? `&search=${encodeURIComponent(search)}` : ''}${tag ? `&tag=${encodeURIComponent(tag)}` : ''}`}
                style="
                  padding: 12px 24px;
                  border-radius: 8px;
                  text-decoration: none;
                  background: #f5f5f5;
                  color: #333;
                  border: 1px solid #e0e0e0;
                  font-weight: 500;
                "
              >
                ‚Üê Anterior
              </a>
            )}

            <span style="color: #666; font-weight: 500;">
              P√°gina {pagination.page} de {pagination.pageCount}
            </span>

            {pagination.page < pagination.pageCount && (
              <a
                href={`/noticias?page=${pagination.page + 1}${search ? `&search=${encodeURIComponent(search)}` : ''}${tag ? `&tag=${encodeURIComponent(tag)}` : ''}`}
                style="
                  padding: 12px 24px;
                  border-radius: 8px;
                  text-decoration: none;
                  background: #f5f5f5;
                  color: #333;
                  border: 1px solid #e0e0e0;
                  font-weight: 500;
                "
              >
                Siguiente ‚Üí
              </a>
            )}
          </nav>
        )}
      </>
    )}
  </main>
</BaseLayout>
